name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Backend Python tests and linting
  backend-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Lint with ruff
      run: |
        ruff check .

    - name: Format check with ruff
      run: |
        ruff format --check .

    - name: Type check with mypy (if enabled)
      run: |
        mypy app/ backend.py wsgi.py || true
      continue-on-error: true

    - name: Run Python tests
      run: |
        pytest --tb=short -v
      env:
        FLASK_ENV: development

  # Frontend unit tests with Vitest
  frontend-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run Vitest unit tests
      run: npm test

  # E2E tests with Playwright
  # SAFETY-CRITICAL: This job runs the silent truncation regression test
  # which guards against S0 bugs. Do not disable without explicit approval.
  e2e-tests:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Node dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium

    - name: Run Playwright E2E tests
      run: npm run test:e2e
      env:
        FLASK_ENV: development
        PORT: 5001

    - name: Upload Playwright report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 7

  # Accessibility and validation tests
  accessibility-tests:
    runs-on: ubuntu-latest
    needs: [backend-tests]

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Start test server
      run: |
        python backend.py &
        echo "Waiting for server to start on port 5001..."
        for i in {1..30}; do
          if curl -s http://localhost:5001/ > /dev/null 2>&1; then
            echo "Server is ready!"
            break
          fi
          echo "Attempt $i: Server not ready yet, waiting..."
          sleep 2
        done
        # Final check
        if ! curl -s http://localhost:5001/ > /dev/null 2>&1; then
          echo "ERROR: Server failed to start after 60 seconds"
          exit 1
        fi
      env:
        FLASK_ENV: development
        PORT: 5001

    - name: Setup Node.js for Lighthouse
      uses: actions/setup-node@v6
      with:
        node-version: '20'

    - name: Install Lighthouse CI
      run: npm install -g @lhci/cli

    - name: Run Lighthouse Accessibility Audit
      run: |
        lhci autorun --collect.url=http://localhost:5001
      continue-on-error: false

    - name: W3C HTML Validation
      uses: Cyb3r-Jak3/html5validator-action@v8.0.0
      with:
        root: public/
        format: text
        # Skip CSS validation - the W3C validator doesn't recognize modern CSS features
        # like env() for iOS safe area support (CSS Environment Variables Module Level 1)
        extra: --also-check-css false
