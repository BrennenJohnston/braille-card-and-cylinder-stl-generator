<!-- VERSION: 2024-12-19-revised -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Braille Business Card STL Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(120deg, #e0e7ff 0%, #f6f8fa 100%);
            min-height: 100vh;
            font-family: 'Inter', system-ui, Arial, sans-serif;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .main-layout {
            display: flex;
            flex-direction: row;
            gap: 2.5em;
            background: #fff;
            border-radius: 22px;
            box-shadow: 0 8px 32px rgba(49,130,206,0.10);
            padding: 2.5em 2.5em 2.5em 2.5em;
            max-width: 1100px;
            width: 100%;
            margin: 2em auto;
        }
        .viewer-section {
            flex: 2 1 0%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #viewer {
            width: 100%;
            min-width: 320px;
            max-width: 700px;
            height: 420px;
            border-radius: 18px;
            border: 2px solid #e2e8f0;
            background: #f1f5f9;
            box-shadow: 0 4px 24px rgba(49,130,206,0.10);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5em;
            transition: box-shadow 0.2s;
        }
        #viewer:focus-within, #viewer:active {
            box-shadow: 0 8px 32px rgba(49,130,206,0.18);
        }
        .form-section {
            flex: 1 1 0%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 320px;
            max-width: 400px;
        }
        h1 {
            font-size: 2.2em;
            font-weight: 700;
            margin-bottom: 0.7em;
            color: #2d3748;
            text-align: left;
        }
        .info-panel {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1em;
            margin-bottom: 1.5em;
            font-size: 0.9em;
            color: #4a5568;
        }
        .info-panel p {
            margin: 0.3em 0;
        }
        .grade-selection {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1em;
            margin-bottom: 1.5em;
        }
        .grade-label {
            font-weight: 600;
            color: #2d3748;
            display: block;
            margin-bottom: 0.8em;
            font-size: 0.9em;
        }
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.6em;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.6em;
            cursor: pointer;
            font-size: 0.9em;
            color: #4a5568;
        }
        .radio-option input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }
        .radio-text {
            cursor: pointer;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 1.1em;
        }
        .line-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.8em;
        }
        .line-input {
            display: flex;
            align-items: center;
            gap: 0.8em;
        }
        .line-label {
            font-weight: 600;
            color: #2d3748;
            min-width: 60px;
            font-size: 0.9em;
        }
        input[type="text"] {
            flex: 1;
            border: 1.5px solid #cbd5e1;
            border-radius: 8px;
            padding: 0.8em;
            font-size: 1em;
            font-family: inherit;
            background: #f9fafb;
            transition: border 0.2s;
        }
        input[type="text"]:focus {
            border: 1.5px solid #3182ce;
            outline: none;
            background: #fff;
        }
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 0.8em;
            margin-top: 1em;
        }
        button {
            border: none;
            border-radius: 8px;
            padding: 0.7em 0;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }
        button[type="submit"] {
            background: linear-gradient(90deg, #3182ce 60%, #63b3ed 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(49,130,206,0.08);
        }
        button[type="submit"]:hover {
            background: linear-gradient(90deg, #2563eb 60%, #4299e1 100%);
            transform: translateY(-2px) scale(1.03);
        }
        #download-btn {
            display: none;
            background: linear-gradient(90deg, #3182ce 60%, #63b3ed 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(49,130,206,0.08);
        }
        #download-btn:hover {
            background: linear-gradient(90deg, #2563eb 60%, #4299e1 100%);
            transform: translateY(-2px) scale(1.03);
        }
        #download-counter-plate-btn {
            background: #6b7280;
            color: #fff;
        }
        #download-counter-plate-btn:hover {
            background: #4b5563;
            transform: translateY(-2px) scale(1.03);
        }
        #error-message {
            color: #b91c1c;
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            padding: 0.7em 1em;
            margin-top: 0.5em;
            font-size: 1em;
            display: none;
            align-items: center;
            gap: 0.5em;
        }
        
        #error-message.info {
            color: #1e40af;
            background: #dbeafe;
            border: 1px solid #93c5fd;
        }
        
        .expert-mode-toggle {
            margin-top: 1em;
            text-align: center;
        }
        
        .expert-toggle-btn {
            background: #e2e8f0;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 0.6em 1em;
            font-size: 0.9em;
            font-weight: 600;
            color: #4a5568;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5em;
            transition: background 0.2s, border-color 0.2s;
        }
        
        .expert-toggle-btn:hover {
            background: #d1d5db;
            border-color: #a0aec0;
        }
        
        .expert-toggle-btn.active {
            background: #3182ce;
            color: #fff;
            border-color: #3182ce;
        }
        
        .expert-toggle-btn.active #expert-toggle-text {
            color: #fff;
        }
        
        .expert-toggle-btn.active #expert-toggle-icon {
            transform: rotate(180deg);
        }
        
        .expert-settings {
            margin-top: 1.5em;
            padding-top: 1.5em;
            border-top: 1px solid #e2e8f0;
        }
        .expert-mode-toggle {
            margin-top: 1em;
            text-align: center;
        }
        .expert-toggle-btn {
            background: #e2e8f0;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 0.6em 1em;
            font-size: 0.9em;
            font-weight: 600;
            color: #4a5568;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5em;
            transition: background 0.2s, border-color 0.2s;
        }
        .expert-toggle-btn:hover {
            background: #d1d5db;
            border-color: #a0aec0;
        }
        .expert-toggle-btn.active {
            background: #3182ce;
            color: #fff;
            border-color: #3182ce;
        }
        .expert-toggle-btn.active #expert-toggle-text {
            color: #fff;
        }
        .expert-toggle-btn.active #expert-toggle-icon {
            transform: rotate(180deg);
        }
        .expert-settings {
            margin-top: 1.5em;
            padding-top: 1.5em;
            border-top: 1px solid #e2e8f0;
        }
        @media (max-width: 1100px) {
            .main-layout {
                flex-direction: column;
                padding: 1.2em 0.5em 1.5em 0.5em;
                max-width: 98vw;
                gap: 1.5em;
            }
            .viewer-section, .form-section {
                max-width: 98vw;
                min-width: unset;
            }
            #viewer {
                max-width: 98vw;
                min-width: 0;
                height: 320px;
            }
        }
        @media (max-width: 700px) {
            .main-layout {
                padding: 0.5em 0.1em 1em 0.1em;
            }
            #viewer {
                height: 220px;
            }
            .line-input {
                flex-direction: column;
                align-items: stretch;
                gap: 0.3em;
            }
            .line-label {
                min-width: unset;
            }
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <div class="viewer-section">
            <div id="viewer"></div>
            <button id="download-btn">Download STL</button>
        </div>
        <div class="form-section">
            <h1>English to Braille STL Generator</h1>
            
            <div class="info-panel">
                <p><strong>For Business Cards:</strong> 3.5 in Ã— 2 in</p>
                <p><strong>Enter English text in up to 4 lines</strong> (The program will automatically translate to braille)</p>
                <p><strong>Translation Engine:</strong> Liblouis - Professional open-source braille translator</p>
            </div>
            
            <form id="braille-form">
                <div class="line-input-group">
                    <label class="grade-label">Enter English Text (Will be automatically translated to braille)</label>
                    <div class="line-input">
                        <span class="line-label">Line 1</span>
                        <input type="text" id="line1" name="line1" placeholder="Enter English text here..." maxlength="50">
                    </div>
                    <div class="line-input">
                        <span class="line-label">Line 2</span>
                        <input type="text" id="line2" name="line2" placeholder="Enter English text here..." maxlength="50">
                    </div>
                    <div class="line-input">
                        <span class="line-label">Line 3</span>
                        <input type="text" id="line3" name="line3" placeholder="Enter English text here..." maxlength="50">
                    </div>
                    <div class="line-input">
                        <span class="line-label">Line 4</span>
                        <input type="text" id="line4" name="line4" placeholder="Enter English text here..." maxlength="50">
                    </div>
                </div>

                <div class="grade-selection">
                    <label class="grade-label">Braille Grade (Select translation level)</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="grade" value="g1">
                            <span class="radio-text">Grade 1 (UEB - Uncontracted, each letter spelled out)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="grade" value="g2" checked>
                            <span class="radio-text">Grade 2 (UEB - Unified English Braille with contractions)</span>
                        </label>
                    </div>
                    <div class="grade-info" style="margin-top: 8px; font-size: 0.9em; color: #666; font-style: italic;">
                        <span id="grade1-info" style="display: none;">Grade 1 (UEB): Each character = 1 braille cell</span>
                        <span id="grade2-info">Grade 2 (UEB): Uses modern contractions (e.g., "the" = 1 cell, "and" = 1 cell) - check limits after translation</span>
                    </div>
                </div>

                <div class="grade-selection">
                    <label class="grade-label">Plate Type (Select which model to generate)</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="plate_type" value="positive" checked>
                            <span class="radio-text">Emboss Plate (Raised Dots)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="plate_type" value="negative">
                            <span class="radio-text">Counter Plate (With Holes)</span>
                        </label>
                        <div id="negative-plate-offset-container" style="display: none; margin-top: 10px;">
                            <label for="negative_plate_offset">Negative Plate Offset:</label>
                            <input type="number" id="negative_plate_offset" name="negative_plate_offset" value="0.4" step="0.1">
                        </div>
                    </div>
                </div>

                <div class="grade-selection">
                    <label class="grade-label">Plate Adjustments (Changes apply to both Emboss and Counter Plate)</label>
                </div>

                <div class="expert-mode-toggle">
                    <button type="button" id="expert-toggle" class="expert-toggle-btn">
                        <span id="expert-toggle-text">Show Expert Mode</span>
                        <span id="expert-toggle-icon">â–¼</span>
                    </button>
                </div>

                <div id="expert-settings" class="expert-settings" style="display: none;">
                    <div class="grade-selection">
                        <label class="grade-label">Braille Dimensions</label>
                        <div>
                            <label for="grid_columns">Number of Braille Cells (Characters):</label>
                            <input type="number" id="grid_columns" name="grid_columns" value="13">
                            <div style="font-size: 0.85em; color: #666; margin-top: 2px;">
                                Note: In Grade 2, contractions may make braille shorter than original text
                            </div>
                        </div>
                        <div>
                            <label for="grid_rows">Number of Braille Lines:</label>
                            <input type="number" id="grid_rows" name="grid_rows" value="4">
                        </div>
                        <div>
                            <label for="cell_spacing">Braille Cell Spacing:</label>
                            <input type="number" id="cell_spacing" name="cell_spacing" value="7.0" step="0.1">
                        </div>
                        <div>
                            <label for="line_spacing">Braille Line Spacing:</label>
                            <input type="number" id="line_spacing" name="line_spacing" value="12.0" step="0.1">
                        </div>
                        <div>
                            <label for="dot_spacing">Braille Dot Spacing:</label>
                            <input type="number" id="dot_spacing" name="dot_spacing" value="2.5" step="0.1">
                        </div>
                    </div>

                    <div class="grade-selection">
                        <label class="grade-label">Dot Dimensions</label>
                        <div>
                            <label for="dot_base_diameter">Dot diameter:</label>
                            <input type="number" id="dot_base_diameter" name="dot_base_diameter" value="2.0" step="0.1">
                        </div>
                        <div>
                            <label for="dot_height">Dot height:</label>
                            <input type="number" id="dot_height" name="dot_height" value="1.4" step="0.1">
                        </div>
                        <div>
                            <label for="dot_hat_size">Flat hat diameter:</label>
                            <input type="number" id="dot_hat_size" name="dot_hat_size" value="0.8" step="0.1">
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" id="preview-braille-btn">Preview Braille Translation</button>
                    <button type="submit">Generate STL</button>
                </div>
            </form>
            
            <div id="braille-preview" style="display: none; margin-top: 20px; padding: 15px; background: #f0f8ff; border: 1px solid #b3d9ff; border-radius: 8px;">
                <h3 style="margin-top: 0; color: #2d3748;">Braille Translation Preview:</h3>
                <div id="preview-content"></div>
            </div>
            
            <div id="error-message">
                <span style="font-weight:bold;">âš </span> 
                <span id="error-text"></span>
            </div>
        </div>
    </div>
    

    
    <!-- Load the real liblouis JavaScript implementation from node_modules -->
    <script src="/node_modules/liblouis-build/build-no-tables-utf16.js"></script>
    <script src="/node_modules/liblouis/easy-api.js"></script>
    
    <script type="module">
        import * as THREE from '/static/three.module.js';
        import { STLLoader } from '/static/STLLoader.js';
        import { OrbitControls } from '/static/OrbitControls.js';

        const form = document.getElementById('braille-form');
        const viewer = document.getElementById('viewer');
        const downloadBtn = document.getElementById('download-btn');

        const previewBrailleBtn = document.getElementById('preview-braille-btn');
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const negativePlateOffsetContainer = document.getElementById('negative-plate-offset-container');
        const expertToggleBtn = document.getElementById('expert-toggle');
        const expertSettings = document.getElementById('expert-settings');
        const expertToggleText = document.getElementById('expert-toggle-text');
        const expertToggleIcon = document.getElementById('expert-toggle-icon');
        const braillePreview = document.getElementById('braille-preview');
        const previewContent = document.getElementById('preview-content');
        let renderer, scene, camera, mesh, controls;
        let lastSTLUrl = null;

        document.querySelectorAll('input[name="plate_type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                negativePlateOffsetContainer.style.display = this.value === 'negative' ? 'block' : 'none';
            });
        });

        // Handle grade selection changes to show appropriate info
        document.querySelectorAll('input[name="grade"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const grade1Info = document.getElementById('grade1-info');
                const grade2Info = document.getElementById('grade2-info');
                
                if (this.value === 'g1') {
                    grade1Info.style.display = 'inline';
                    grade2Info.style.display = 'none';
                } else {
                    grade1Info.style.display = 'none';
                    grade2Info.style.display = 'inline';
                }
            });
        });

        expertToggleBtn.addEventListener('click', () => {
            const isVisible = expertSettings.style.display !== 'none';
            expertSettings.style.display = isVisible ? 'none' : 'block';
            expertToggleText.textContent = isVisible ? 'Show Expert Mode' : 'Hide Expert Mode';
            expertToggleIcon.textContent = isVisible ? 'â–¼' : 'â–²';
            expertToggleBtn.classList.toggle('active', !isVisible);
        });

        // Preview braille translation using real liblouis
        previewBrailleBtn.addEventListener('click', async () => {
            const lines = [
                document.getElementById('line1').value,
                document.getElementById('line2').value,
                document.getElementById('line3').value,
                document.getElementById('line4').value
            ];
            
            const grade = document.querySelector('input[name="grade"]:checked').value;
            
            if (lines.every(line => !line.trim())) {
                errorText.textContent = 'Please enter text in at least one line.';
                errorDiv.style.display = 'flex';
                return;
            }

            errorDiv.style.display = 'none';
            let previewHTML = '';
            
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].trim()) {
                    try {
                        // Use real liblouis translation
                        const braille = await translateWithLiblouis(lines[i].trim(), grade);
                        previewHTML += `<div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px; border: 1px solid #e2e8f0;">
                            <strong>Line ${i + 1}:</strong> "${lines[i].trim()}" â†’ "${braille}"
                        </div>`;
                    } catch (error) {
                        console.error('Translation failed for line', i + 1, ':', error);
                        previewHTML += `<div style="margin: 10px 0; padding: 10px; background: #fee2e2; border-radius: 5px; border: 1px solid #fecaca;">
                            <strong>Line ${i + 1}:</strong> "${lines[i].trim()}" â†’ Error: ${error.message}
                        </div>`;
                    }
                }
            }
            
            previewContent.innerHTML = previewHTML;
            braillePreview.style.display = 'block';
        });

        function init3D() {
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(viewer.clientWidth, viewer.clientHeight);
            viewer.innerHTML = '';
            viewer.appendChild(renderer.domElement);
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, viewer.clientWidth/viewer.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 120);
            camera.lookAt(0, 0, 0);
            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 0, 0);
            controls.update();
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(0, 0, 100).normalize();
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x888888));
        }

        function render() {
            renderer.render(scene, camera);
        }

        form.onsubmit = async (e) => {
            e.preventDefault();
            errorDiv.style.display = 'none';
            errorText.textContent = '';
            
            // Collect all line inputs
            const lines = [
                document.getElementById('line1').value,
                document.getElementById('line2').value,
                document.getElementById('line3').value,
                document.getElementById('line4').value
            ];
            
            const plateType = document.querySelector('input[name="plate_type"]:checked').value;
            const grade = document.querySelector('input[name="grade"]:checked').value;
            
            // Translate text to braille before sending to backend
            const translatedLines = [];
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    try {
                        console.log(`Translating line ${i + 1}: '${line}' to braille...`);
                        const brailleText = await translateWithLiblouis(line, grade);
                        console.log(`Line ${i + 1} translated: '${line}' â†’ '${brailleText}'`);
                        translatedLines.push(brailleText);
                    } catch (error) {
                        console.error(`Failed to translate line ${i + 1}:`, error);
                        // Fallback to original text if translation fails
                        translatedLines.push(line);
                    }
                } else {
                    translatedLines.push('');
                }
            }
            
            console.log('Original lines:', lines);
            console.log('Translated lines:', translatedLines);
            const settings = {
                grid_columns: document.getElementById('grid_columns').value,
                grid_rows: document.getElementById('grid_rows').value,
                cell_spacing: document.getElementById('cell_spacing').value,
                line_spacing: document.getElementById('line_spacing').value,
                dot_spacing: document.getElementById('dot_spacing').value,
                dot_base_diameter: document.getElementById('dot_base_diameter').value,
                dot_height: document.getElementById('dot_height').value,
                dot_hat_size: document.getElementById('dot_hat_size').value,
                negative_plate_offset: document.getElementById('negative_plate_offset').value
            };
            
            // Check if at least one line has content
            if (lines.every(line => !line.trim())) {
                errorText.textContent = 'Please enter text in at least one line.';
                errorDiv.style.display = 'flex';
                return;
            }
            
            // Validate braille character limits AFTER translation
            const gridColumns = parseInt(document.getElementById('grid_columns').value);
            for (let i = 0; i < translatedLines.length; i++) {
                const brailleLine = translatedLines[i];
                if (brailleLine && brailleLine.length > gridColumns) {
                    const over = brailleLine.length - gridColumns;
                    errorText.textContent = `Line ${i + 1} exceeds ${gridColumns} braille cells by ${over} cells after translation. Please shorten your text.`;
                    errorDiv.style.display = 'flex';
                    errorDiv.className = 'error-message';
                    return;
                }
            }
            
            // Show loading message during translation
            errorText.textContent = 'Translating text to braille...';
            errorDiv.style.display = 'flex';
            errorDiv.className = 'error-message info';
            
            const res = await fetch('/generate_braille_stl', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lines: translatedLines, grade: grade, plate_type: plateType, settings: settings })
            });
            
            // Hide loading message
            errorDiv.style.display = 'none';
            
            if (!res.ok) {
                let msg = 'Error generating STL';
                try {
                    const data = await res.json();
                    if (data.error) msg = data.error;
                } catch (e) {
                    msg = `Server error: ${res.status} ${res.statusText}`;
                }
                errorText.textContent = msg;
                errorDiv.style.display = 'flex';
                errorDiv.className = 'error-message'; // Reset to error style
                return;
            }
            
            try {
                const blob = await res.blob();
                if (lastSTLUrl) URL.revokeObjectURL(lastSTLUrl);
                lastSTLUrl = URL.createObjectURL(blob);
                loadSTL(lastSTLUrl);
                downloadBtn.style.display = 'inline-block';
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = lastSTLUrl;
                    a.download = 'braille_card.stl';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };
            } catch (e) {
                errorText.textContent = 'Failed to process STL file: ' + e.message;
                errorDiv.style.display = 'flex';
                errorDiv.className = 'error-message'; // Reset to error style
            }
        };



        function loadSTL(url) {
            init3D();
            const loader = new STLLoader();
            loader.load(url, function (geometry) {
                geometry.center();
                if (mesh) scene.remove(mesh);
                const material = new THREE.MeshPhongMaterial({ 
                    color: 0x6699cc, 
                    specular: 0x111111, 
                    shininess: 200 
                });
                mesh = new THREE.Mesh(geometry, material);
                mesh.rotation.x = 0;
                scene.add(mesh);
                animate();
            }, undefined, function (error) {
                errorText.textContent = 'Failed to load STL: ' + error;
                errorDiv.style.display = 'flex';
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            controls && controls.update();
            render();
        }
        
        // Initialize liblouis web worker and 3D viewer on page load
        let liblouisWorker = null;
        let liblouisReady = false;
        let workerMessageId = 0;
        let pendingWorkerMessages = new Map();
        
        // Function to send message to worker and get response
        function sendWorkerMessage(type, data = {}) {
            return new Promise((resolve, reject) => {
                if (!liblouisWorker) {
                    reject(new Error('Worker not initialized'));
                    return;
                }
                
                const id = ++workerMessageId;
                pendingWorkerMessages.set(id, { resolve, reject });
                
                liblouisWorker.postMessage({ id, type, data });
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    if (pendingWorkerMessages.has(id)) {
                        pendingWorkerMessages.delete(id);
                        reject(new Error('Worker message timeout'));
                    }
                }, 10000);
            });
        }
        
        window.addEventListener('load', async () => {
            try {
                // Initialize liblouis web worker
                console.log('Initializing liblouis web worker...');
                
                // Test if worker file is accessible first
                try {
                    const workerResponse = await fetch('/static/liblouis-worker.js');
                    if (!workerResponse.ok) {
                        throw new Error(`Worker file not accessible: ${workerResponse.status}`);
                    }
                    console.log('Worker file is accessible');
                } catch (fetchError) {
                    console.error('Worker file test failed:', fetchError);
                    throw new Error('Cannot access worker file: ' + fetchError.message);
                }
                
                liblouisWorker = new Worker('/static/liblouis-worker.js');
                
                // Handle worker messages
                liblouisWorker.onmessage = function(e) {
                    const { id, type, result } = e.data;
                    
                    if (pendingWorkerMessages.has(id)) {
                        const { resolve, reject } = pendingWorkerMessages.get(id);
                        pendingWorkerMessages.delete(id);
                        
                        if (result.success) {
                            resolve(result);
                        } else {
                            reject(new Error(result.error));
                        }
                    }
                };
                
                liblouisWorker.onerror = function(error) {
                    console.error('Worker error:', error);
                };
                
                // Initialize liblouis in the worker
                const initResult = await sendWorkerMessage('init');
                if (initResult.success) {
                    liblouisReady = true;
                    console.log('Liblouis web worker initialized successfully');
                } else {
                    throw new Error('Failed to initialize liblouis worker: ' + initResult.error);
                }
                
            } catch (error) {
                console.error('Failed to initialize liblouis worker:', error);
                
                // Fallback: disable liblouis and show error message
                console.log('Web worker failed - disabling liblouis translation');
                liblouisReady = false;
                liblouisWorker = null;
                
                // Show user that translation is disabled
                const errorDiv = document.getElementById('error-message');
                const errorText = document.getElementById('error-text');
                if (errorDiv && errorText) {
                    errorText.textContent = 'Web worker failed to initialize. Braille translation preview is disabled on this deployment.';
                    errorDiv.style.display = 'flex';
                }
            }
            
            init3D();
            animate();
        });

        // Function to translate text using liblouis web worker
        async function translateWithLiblouis(text, grade) {
            if (!liblouisReady || !liblouisWorker) {
                throw new Error('Liblouis worker not initialized - translation preview unavailable on this deployment');
            }
            
            try {
                console.log('Sending translation request to worker:', text, 'grade:', grade);
                const result = await sendWorkerMessage('translate', { text, grade });
                
                if (result.success && result.translation) {
                    console.log('Translation successful:', result.translation);
                    return result.translation;
                } else {
                    throw new Error('Translation failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Worker translation failed:', error);
                throw error;
            }
        }
    </script>
</body>
</html> 